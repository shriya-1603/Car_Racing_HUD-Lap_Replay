/* =========================
   BASE & THEME
   ========================= */
:root{
  --bg:#0b0b0c; --card:#131316; --ink:#f1f1f4; --muted:#aeb0b7;
  --accent:#00e6b8; --yellow:#ffe36b; --red:#ff4d6d;

  /* Lap durations (lower = faster) */
  --spd-1:24s; --spd-2:20s; --spd-3:16s; --spd-4:12s; --spd-5:9s; --spd-6:7s; --spd-7:5s;

  /* Final needle mapping you ended with (keep exact output) */
  --deg-1:-225deg; --deg-2:-180deg; --deg-3:-135deg; --deg-4:-90deg;
  --deg-5:-45deg;  --deg-6:0deg;    --deg-7:45deg;

  /* Oval path used by car */
  --oval-path:path("M 120 250 C 120 120, 280 60, 400 60 C 520 60, 680 120, 680 250 C 680 380, 520 440, 400 440 C 280 440, 120 380, 120 250 Z");
}
/* animatable % custom properties */
@property --prog-normal { syntax:'<percentage>'; inherits:false; initial-value:0%; }
@property --prog-pit    { syntax:'<percentage>'; inherits:false; initial-value:0%; }
@property --prog-cur    { syntax:'<percentage>'; inherits:false; initial-value:0%; }
@property --pit-active { syntax:'<number>'; inherits:true; initial-value:0; }


/* where the pit line sits along the lap (tweak if your box shifts) */
:root{
  --pit-dist: 26%;
  /* defaults (overridden per speed below) */
  --pre-slow: 10%;
  --pit-hold: 10%;
}


*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0; color:var(--ink);
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
  background:radial-gradient(1200px 600px at 20% -10%, #222 0%, transparent 60%), var(--bg);
}

/* Layout chrome (unchanged) */
.topbar{ position:sticky; top:0; z-index:50; display:flex; align-items:center; gap:12px; padding:12px 20px; border-bottom:1px solid #2a2b2f; backdrop-filter:blur(6px); background:rgba(11,11,12,.7); }
.topbar h1{ margin:0; font-weight:900; letter-spacing:-.02em; }
.subtitle{ margin-left:auto; color:#c8c9cf; font-size:12px; opacity:.8; }
.layout{ max-width:1100px; margin:24px auto; padding:0 16px; display:grid; grid-template-columns:1fr; gap:16px; }
.card{ border:1px solid #2a2b2f; background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 50%), var(--card); border-radius:18px; padding:16px; position:relative; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.25); }
.intro .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.intro h2{ margin:6px 0 12px; } .intro h3{ margin:10px 0 4px; font-size:14px; color:var(--muted); }
.intro .span2{ grid-column:1 / -1; } .intro ul{ margin:6px 0 0 18px; }

/* =========================
   HUD / GLOBAL STATE
   ========================= */
.hud{ padding:0; position:relative; }
.state{ position:absolute; opacity:0; pointer-events:none; }

.flag-banner{ position:absolute; inset-inline:0; top:6px; display:flex; justify-content:center; pointer-events:none; z-index:5; }
.flag-text{
  display:inline-block; padding:4px 10px; border-radius:999px; font-weight:700; letter-spacing:.08em;
  background:var(--red); color:#fff; box-shadow:0 8px 24px rgba(0,0,0,.25); transition:background-color .3s ease,color .3s ease;
}

/* Flag tint & banner color */
#flag-red:checked    ~ .flag-banner .flag-text{ background:var(--red); color:#fff; }
#flag-green:checked  ~ .flag-banner .flag-text{ background:#27d39b; color:#000; }
#flag-yellow:checked ~ .flag-banner .flag-text{ background:var(--yellow); color:#000; animation:flagPulse .8s ease-in-out infinite alternate; }
@keyframes flagPulse{ from{opacity:.7} to{opacity:1} }

.hud-grid{
  display:grid; gap:16px; padding:16px; grid-template-columns:1.6fr 1fr;
  --base:var(--spd-1);   /* current speed (overridden by radios) */
  --flag-mult:1;         /* leave at 1 to keep your exact pacing */
}

/* =========================
   TRACK & WEATHER (track-only)
   ========================= */
.track-wrap{
  position: relative;
  border-radius: 16px;
  background: #18181b;
  border: 1px solid #2a2b2f;
  width: 800px;
  height: 500px;
  max-width: 100%;
  margin: 0 auto;
  z-index: 1;

  /* car motion path (mid-lane) */
  --car-path: path("M 400 425 C 275 425, 120 360, 128.5 250 C 115 145, 275 74, 400 75 C 525 75, 680 140, 675 250 C 675 360, 535 425, 400 425 Z");
  --lane-nudge: 14px;
  /* --prog-cur: calc((1 - var(--pit-active)) * var(--prog-normal) + var(--pit-active) * var(--prog-pit)); */
}

.track{ position:absolute; inset:0; z-index:1; }
.flag-bg{ transition:background-color .3s ease; }

/* Flash veil (above car, below UI) */
.track-wrap::before{
  content:""; position:absolute; inset:0; pointer-events:none; z-index:25; opacity:0;
  background:
    radial-gradient(58% 58% at 50% 50%, rgba(255,255,255,.55), rgba(255,255,255,0) 72%),
    radial-gradient(24% 24% at 50% 50%, rgba(255,255,255,.35), rgba(255,255,255,0) 54%);
  mix-blend-mode:screen;
}

/* Track-only yellow chevrons + rain streaks (masked ring) */
.track-wrap::after{
  content:""; position:absolute; inset:0; pointer-events:none; z-index:2; mix-blend-mode:screen;

  /* effect opacities controlled by state toggles below */
  --chev-alpha:0; --rain-alpha:0;

  background-image:
    repeating-linear-gradient(-45deg, rgba(255,227,107,var(--chev-alpha)) 0 16px, rgba(255,227,107,0) 16px 32px),
    repeating-linear-gradient(-40deg, rgba(190,225,255,var(--rain-alpha)) 0 2px,  rgba(190,225,255,0)  2px 22px);
  background-size:200% 200%, 18px 28px;
  animation:chevrons 3s linear infinite, rainDrift 1.35s linear infinite;

  /* mask to the asphalt ring */
   /* mask to the asphalt ring — UPDATED paths */
  -webkit-mask:
    path("M 120 250 C  90 150, 260  58, 400  60 C 540  60, 700 140, 690 250 C 690 360, 560 440, 400 440 C 260 440, 100 360, 117 250 Z") center / 800px 500px no-repeat,
    path("M 140 250 C 140 140, 290  90, 400  90 C 510  90, 660 140, 660 250 C 660 360, 510 410, 400 410 C 290 410, 140 360, 140 250 Z") center / 800px 500px no-repeat;
  -webkit-mask-composite:source-over, xor;
          mask:
    path("M 120 250 C  90 150, 260  58, 400  60 C 540  60, 700 140, 690 250 C 690 360, 560 440, 400 440 C 260 440, 100 360, 117 250 Z") center / 800px 500px no-repeat,
    path("M 140 250 C 140 140, 290  90, 400  90 C 510  90, 660 140, 660 250 C 660 360, 510 410, 400 410 C 290 410, 140 360, 140 250 Z") center / 800px 500px no-repeat;
  mask-composite:exclude;
}
@keyframes chevrons{ to{ background-position:100% 100%, 0 0; } }
@keyframes rainDrift{ 0%{ background-position:0 0, 0 -60px; } 100%{ background-position:100% 100%, -42px 60px; } }

/* Flag/Weather → raise effect alphas */
#flag-yellow:checked ~ .hud-grid .track-wrap::after{ --chev-alpha:.35; }
#weather-rain:checked ~ .hud-grid .track-wrap::after{ --rain-alpha:.16; }

/* =========================
   CAR (path follower) + GHOST
   ========================= */
.car{
  /* final footprint you wanted (not skinny) */
  --car-w:50px; --car-h:26px;
  width:var(--car-w); height:var(--car-h);

  position:absolute; top:0; left:0;
  transform:
    translate(calc(-.5*var(--car-w)), calc(-.5*var(--car-h)))
    translateY(var(--lane-nudge));
  offset-path: var(--car-path)!important; offset-rotate:auto;
  offset-distance: calc(
    (1 - var(--pit-active)) * var(--prog-normal) +
    var(--pit-active) * var(--prog-pit)
  );

  /* keep your dual timelines */
  animation-name: normalLap, var(--pit-anim, pitLap4);

  /* CHANGED: use the selected pit animation name variable */

  animation-name: normalLap, var(--pit-anim, pitLap4);
  animation-duration: calc(var(--base) * var(--flag-mult)), calc(var(--base) * var(--flag-mult));
  animation-timing-function: linear, linear;
  animation-iteration-count: infinite, 1;   /* normal loops, PIT runs once */
  animation-play-state: paused, paused;     /* both paused initially */
  animation-fill-mode: none, both;     /* both paused initially */

  /* visual */
  background-repeat:no-repeat; background-position:center; background-size:contain;
  isolation:isolate; mix-blend-mode:normal; z-index:6;
  filter:drop-shadow(0 2px 6px #00000073) drop-shadow(0 0 6px rgba(0,230,184,.35));
}
/* Remove old boxy parts, we draw via background-SVG skins */
.car .body,.car .cockpit,.car .spoiler,.car .wheel,.car .headlight{ display:none !important; }

/* Ghost lap */
/* .car.ghost{
  opacity:.9;
  /* one full lap on the same “normal” timeline */
  /* animation:normalLap calc(var(--base) * var(--flag-mult)) linear 1 paused;
  filter:drop-shadow(0 0 6px rgba(176,136,255,.6)) brightness(.8);
} */ 

/* @keyframes drive{ from{offset-distance:0%} to{offset-distance:100%} } */

/* External hazard/parking lights mounted outside body */
.car::before,.car::after{
  content:""; position:absolute; top:50%; width:5px; height:5px;
  background:#ffc64a; border-radius:50%; transform:translateY(-50%);
  box-shadow:0 0 8px 3px rgba(255,198,74,.45), 0 0 14px 6px rgba(255,198,74,.25);
  opacity:0; pointer-events:none; z-index:7; transition:opacity .2s ease;
}
.car::before{ left:-6px; } .car::after{ right:-6px; }

/* Yellow flag → blink; Rain → steady; Both → blink wins */
@keyframes hazardBlink{ 0%,49%{opacity:1} 50%,100%{opacity:.2} }
#flag-yellow:checked ~ .hud-grid .car::before,
#flag-yellow:checked ~ .hud-grid .car::after{ opacity:1; animation:hazardBlink .8s steps(2,end) infinite; }
#weather-rain:checked ~ .hud-grid .car::before,
#weather-rain:checked ~ .hud-grid .car::after{ opacity:1; animation:none; }

/* Run/Stop control (keep precedence) */
#flag-red:checked    ~ .hud-grid .car{ animation-play-state:paused !important; }
#flag-green:checked  ~ .hud-grid .car,
#flag-yellow:checked ~ .hud-grid .car{
  animation-play-state: running, paused;    /* run normal, keep PIT paused */
}

/* Pit & replay */
/* by default the car reads the normal progress */
/* .track-wrap{ --prog-cur: var(--prog-normal); } */

/* REMOVED: forcing pit timeline on the car (we blend at .track-wrap instead) */
/* #pit:checked ~ .hud-grid .car{ --prog-cur: var(--prog-pit); } */
#pit:checked ~ .hud-grid .car{
  animation-name: normalLap, var(--pit-anim, pitLap4);
  animation-duration: calc(var(--base) * var(--flag-mult)), calc(var(--base) * var(--flag-mult));
  animation-iteration-count: infinite, 1;
  animation-direction: normal, normal;
  animation-fill-mode: none, both;
  animation-play-state: running, running;

  /* IMPORTANT: remove the old negative delay that tried to “sync”.
     We want PIT to start NOW at 0% and borrow the live progress at its 0% keyframe. */
  animation-delay: 0s,
    calc( (100% - var(--prog-normal)) * var(--base) / 100 );
}
/* default: pit inactive */
.hud-grid{ --pit-active: 0; }

/* on click: run one lap's worth of pit, then auto-revert */
#pit:checked ~ .hud-grid{
  animation: pitOnce calc(var(--base) * var(--flag-mult)) linear 1 both;
  animation-delay: calc( (100% - var(--prog-normal)) * var(--base) / 100 );
}
@keyframes pitOnce{
  0%, 99% { --pit-active: 1; }  /* use PIT track */
  100%    { --pit-active: 0; }  /* hand back to normal */
}


#replay:checked ~ .hud-grid .car.ghost{ opacity:.95; animation-play-state:running; }

/* =========================
   SPEEDO + SPEED BAR
   ========================= */
.speedo{ border:1px solid #2a2b2f; border-radius:14px; padding:12px; background:#16161a; }
.dial{ width:180px; height:180px; margin:0 auto 10px; position:relative; border-radius:100vmax;
  background:radial-gradient(120px 120px at 50% 50%, #101, #15161a 60%, #0b0b0c);
  box-shadow:inset 0 0 0 2px rgba(255,255,255,.05);
}
.ticks{ position:absolute; inset:10px; border-radius:50%;
  background:
    conic-gradient(from -135deg, rgba(255,255,255,.35) 0 2deg, transparent 0 43deg,
                               rgba(255,255,255,.35) 0 45deg, transparent 0 88deg,
                               rgba(255,255,255,.35) 0 90deg, transparent 0 133deg,
                               rgba(255,255,255,.35) 0 135deg, transparent 0 178deg,
                               rgba(255,255,255,.35) 0 180deg, transparent 0 223deg,
                               rgba(255,255,255,.35) 0 225deg, transparent 0 268deg,
                               rgba(255,255,255,.35) 0 270deg);
}
.needle{ position:absolute; left:50%; top:50%; width:80px; height:4px; background:#ff5478;
  transform-origin:left center; border-radius:4px; box-shadow:-2px 0 10px rgba(255,84,120,.6);
  transform:rotate(-60deg); transition:transform .55s cubic-bezier(.22,.9,.26,1);
}
.cap{ position:absolute; left:50%; top:50%; width:10px; height:10px; translate:-50% -50%; background:#fff; border-radius:50%; }
.mini-stats{ display:grid; grid-template-columns:1fr 1fr; gap:4px; text-align:center; font-size:12px; color:#c8c9cf; }
.mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; }
.hint{ margin:8px 0 0; color:#9aa0a6; font-size:12px; }

.speed-bar{ position:relative; width:100%; max-width:360px; margin:0 auto 2px; display:grid; grid-template-columns:repeat(7, 1fr); gap:6px; z-index:40; }
.speed-bar label{ height:14px; border-radius:999px; cursor:pointer; background:linear-gradient(180deg, #2a2b32, #1c1d22); outline:1px solid #2f3037; position:relative; }
.speed-bar label::after{ content:""; position:absolute; inset:0; border-radius:999px; transform:scaleX(0); transform-origin:left; background:linear-gradient(90deg, #2bd4bd, #00e6b8); transition:transform .25s ease; }

/* Progressive fill */
#spd-1:checked ~ .hud-grid .speed-bar label:nth-of-type(-n+1)::after{ transform:scaleX(1); }
#spd-2:checked ~ .hud-grid .speed-bar label:nth-of-type(-n+2)::after{ transform:scaleX(1); }
#spd-3:checked ~ .hud-grid .speed-bar label:nth-of-type(-n+3)::after{ transform:scaleX(1); }
#spd-4:checked ~ .hud-grid .speed-bar label:nth-of-type(-n+4)::after{ transform:scaleX(1); }
#spd-5:checked ~ .hud-grid .speed-bar label:nth-of-type(-n+5)::after{ transform:scaleX(1); }
#spd-6:checked ~ .hud-grid .speed-bar label:nth-of-type(-n+6)::after{ transform:scaleX(1); }
#spd-7:checked ~ .hud-grid .speed-bar label:nth-of-type(-n+7)::after{ transform:scaleX(1); }

/* Current segment highlight */
#spd-1:checked ~ .hud-grid .speed-bar label[for="spd-1"],
#spd-2:checked ~ .hud-grid .speed-bar label[for="spd-2"],
#spd-3:checked ~ .hud-grid .speed-bar label[for="spd-3"],
#spd-4:checked ~ .hud-grid .speed-bar label[for="spd-4"],
#spd-5:checked ~ .hud-grid .speed-bar label[for="spd-5"],
#spd-6:checked ~ .hud-grid .speed-bar label[for="spd-6"],
#spd-7:checked ~ .hud-grid .speed-bar label[for="spd-7"]{
  box-shadow:0 0 0 2px rgba(43,212,189,.75), 0 0 12px rgba(0,230,184,.55);
  outline-color:rgba(43,212,189,.9); opacity:1 !important; filter:none !important;
}

/* Red = whole bar active; Green/Yellow = only adjacent steps */
#flag-red:checked ~ .hud-grid .speed-bar label{ pointer-events:auto; opacity:1; filter:none; }
#flag-green:checked  ~ .hud-grid .speed-bar label,
#flag-yellow:checked ~ .hud-grid .speed-bar label{ pointer-events:none; opacity:.45; filter:grayscale(.4); }
#spd-1:checked ~ .hud-grid .speed-bar label[for="spd-2"],
#spd-2:checked ~ .hud-grid .speed-bar label[for="spd-1"],
#spd-2:checked ~ .hud-grid .speed-bar label[for="spd-3"],
#spd-3:checked ~ .hud-grid .speed-bar label[for="spd-2"],
#spd-3:checked ~ .hud-grid .speed-bar label[for="spd-4"],
#spd-4:checked ~ .hud-grid .speed-bar label[for="spd-3"],
#spd-4:checked ~ .hud-grid .speed-bar label[for="spd-5"],
#spd-5:checked ~ .hud-grid .speed-bar label[for="spd-4"],
#spd-5:checked ~ .hud-grid .speed-bar label[for="spd-6"],
#spd-6:checked ~ .hud-grid .speed-bar label[for="spd-5"],
#spd-6:checked ~ .hud-grid .speed-bar label[for="spd-7"],
#spd-7:checked ~ .hud-grid .speed-bar label[for="spd-6"]{
  pointer-events:auto !important; opacity:1 !important; filter:none !important;
}

/* Map radios → duration & needle */
#spd-1:checked ~ .hud-grid{ --base:var(--spd-1); }
#spd-2:checked ~ .hud-grid{ --base:var(--spd-2); }
#spd-3:checked ~ .hud-grid{ --base:var(--spd-3); }
#spd-4:checked ~ .hud-grid{ --base:var(--spd-4); }
#spd-5:checked ~ .hud-grid{ --base:var(--spd-5); }
#spd-6:checked ~ .hud-grid{ --base:var(--spd-6); }
#spd-7:checked ~ .hud-grid{ --base:var(--spd-7); }

/* 3s stop in the box and ~1.2s preslow, expressed as % of the current lap time */
#spd-1:checked ~ .hud-grid{ --pit-hold:12.5%;  --pre-slow:5%;      } /* 24s */
#spd-2:checked ~ .hud-grid{ --pit-hold:15%;    --pre-slow:6%;      } /* 20s */
#spd-3:checked ~ .hud-grid{ --pit-hold:18.75%; --pre-slow:7.5%;    } /* 16s */
#spd-4:checked ~ .hud-grid{ --pit-hold:25%;    --pre-slow:10%;     } /* 12s */
#spd-5:checked ~ .hud-grid{ --pit-hold:33.333%;--pre-slow:13.333%; } /* 9s  */
#spd-6:checked ~ .hud-grid{ --pit-hold:42.857%;--pre-slow:17.142%; } /* 7s  */
#spd-7:checked ~ .hud-grid{ --pit-hold:60%;    --pre-slow:24%;     } /* 5s  */
/* pick the pit animation (6s hold) + matching pit UI animation per speed */
#spd-1:checked ~ .hud-grid{ --pit-anim: pitLap1; --pitui-anim: pitUI1; } /* 24s lap */
#spd-2:checked ~ .hud-grid{ --pit-anim: pitLap2; --pitui-anim: pitUI2; } /* 20s lap */
#spd-3:checked ~ .hud-grid{ --pit-anim: pitLap3; --pitui-anim: pitUI3; } /* 16s lap */
#spd-4:checked ~ .hud-grid{ --pit-anim: pitLap4; --pitui-anim: pitUI4; } /* 12s lap */
#spd-5:checked ~ .hud-grid{ --pit-anim: pitLap5; --pitui-anim: pitUI5; } /* 9s  lap */
#spd-6:checked ~ .hud-grid{ --pit-anim: pitLap6; --pitui-anim: pitUI6; } /* 7s  lap (cap) */
#spd-7:checked ~ .hud-grid{ --pit-anim: pitLap7; --pitui-anim: pitUI7; } /* 5s  lap (cap) */

#spd-1:checked ~ .hud-grid .needle{ transform:rotate(var(--deg-1)) !important; }
#spd-2:checked ~ .hud-grid .needle{ transform:rotate(var(--deg-2)) !important; }
#spd-3:checked ~ .hud-grid .needle{ transform:rotate(var(--deg-3)) !important; }
#spd-4:checked ~ .hud-grid .needle{ transform:rotate(var(--deg-4)) !important; }
#spd-5:checked ~ .hud-grid .needle{ transform:rotate(var(--deg-5)) !important; }
#spd-6:checked ~ .hud-grid .needle{ transform:rotate(var(--deg-6)) !important; }
#spd-7:checked ~ .hud-grid .needle{ transform:rotate(var(--deg-7)) !important; }

/* =========================
   MASKED SNAP (flash + body pulse)
   ========================= */
@keyframes flashT1{ from{opacity:.9} to{opacity:0} } @keyframes flashT2{ from{opacity:.9} to{opacity:0} }
@keyframes flashT3{ from{opacity:.9} to{opacity:0} } @keyframes flashT4{ from{opacity:.9} to{opacity:0} }
@keyframes flashT5{ from{opacity:.9} to{opacity:0} } @keyframes flashT6{ from{opacity:.9} to{opacity:0} }
@keyframes flashT7{ from{opacity:.9} to{opacity:0} }

@keyframes pulseB1{ 0%{ filter:brightness(1.35) contrast(1.2) blur(1px) } 100%{ filter:none } }
@keyframes pulseB2{ 0%{ filter:brightness(1.35) contrast(1.2) blur(1px) } 100%{ filter:none } }
@keyframes pulseB3{ 0%{ filter:brightness(1.35) contrast(1.2) blur(1px) } 100%{ filter:none } }
@keyframes pulseB4{ 0%{ filter:brightness(1.35) contrast(1.2) blur(1px) } 100%{ filter:none } }
@keyframes pulseB5{ 0%{ filter:brightness(1.35) contrast(1.2) blur(1px) } 100%{ filter:none } }
@keyframes pulseB6{ 0%{ filter:brightness(1.35) contrast(1.2) blur(1px) } 100%{ filter:none } }
@keyframes pulseB7{ 0%{ filter:brightness(1.35) contrast(1.2) blur(1px) } 100%{ filter:none } }

#spd-1:checked ~ .hud-grid .track-wrap::before{ animation:flashT1 .22s ease !important; }
#spd-2:checked ~ .hud-grid .track-wrap::before{ animation:flashT2 .22s ease !important; }
#spd-3:checked ~ .hud-grid .track-wrap::before{ animation:flashT3 .22s ease !important; }
#spd-4:checked ~ .hud-grid .track-wrap::before{ animation:flashT4 .22s ease !important; }
#spd-5:checked ~ .hud-grid .track-wrap::before{ animation:flashT5 .22s ease !important; }
#spd-6:checked ~ .hud-grid .track-wrap::before{ animation:flashT6 .22s ease !important; }
#spd-7:checked ~ .hud-grid .track-wrap::before{ animation:flashT7 .22s ease !important; }

#spd-1:checked ~ .hud-grid .car .body{ animation:pulseB1 .22s ease 1 !important; }
#spd-2:checked ~ .hud-grid .car .body{ animation:pulseB2 .22s ease 1 !important; }
#spd-3:checked ~ .hud-grid .car .body{ animation:pulseB3 .22s ease 1 !important; }
#spd-4:checked ~ .hud-grid .car .body{ animation:pulseB4 .22s ease 1 !important; }
#spd-5:checked ~ .hud-grid .car .body{ animation:pulseB5 .22s ease 1 !important; }
#spd-6:checked ~ .hud-grid .car .body{ animation:pulseB6 .22s ease 1 !important; }
#spd-7:checked ~ .hud-grid .car .body{ animation:pulseB7 .22s ease 1 !important; }

/* =========================
   PIT PANELS / CONTROLS / RESPONSIVE
   ========================= */
.pit-panels{ position:absolute; left:16px; right:16px; top:10px; display:flex; gap:8px; justify-content:space-between; pointer-events:none; transform:translateY(-18px); opacity:0; transition:transform .45s ease, opacity .45s ease; z-index:3; }
.panel{ background:#22232a; border:1px solid #2f3037; border-radius:10px; padding:6px 10px; font-size:12px; box-shadow:0 4px 16px rgba(0,0,0,.25); }
#pit:checked ~ .hud-grid .pit-panels{
  animation-name: var(--pitui-anim, pitUI4);
  animation-duration: calc(var(--base) * var(--flag-mult));
  animation-timing-function: linear;
  animation-iteration-count: 1;
  animation-fill-mode: both;
}


@keyframes pitUI1{ 0%,14%{opacity:0;transform:translateY(-18px);}  16%,38%{opacity:1;transform:translateY(0);}  40%,100%{opacity:0;transform:translateY(-18px);} }
@keyframes pitUI2{ 0%,14%{opacity:0;transform:translateY(-18px);}  16%,43%{opacity:1;transform:translateY(0);}  45%,100%{opacity:0;transform:translateY(-18px);} }
@keyframes pitUI3{ 0%,14%{opacity:0;transform:translateY(-18px);}  16%,51%{opacity:1;transform:translateY(0);}  52.5%,100%{opacity:0;transform:translateY(-18px);} }
@keyframes pitUI4{ 0%,14%{opacity:0;transform:translateY(-18px);}  16%,63%{opacity:1;transform:translateY(0);}  65%,100%{opacity:0;transform:translateY(-18px);} }
@keyframes pitUI5{ 0%,14%{opacity:0;transform:translateY(-18px);}  16%,80%{opacity:1;transform:translateY(0);}  81.667%,100%{opacity:0;transform:translateY(-18px);} }
@keyframes pitUI6{ 0%,14%{opacity:0;transform:translateY(-18px);}  16%,93%{opacity:1;transform:translateY(0);}  95%,100%{opacity:0;transform:translateY(-18px);} }
@keyframes pitUI7{ 0%,14%{opacity:0;transform:translateY(-18px);}  16%,93%{opacity:1;transform:translateY(0);}  95%,100%{opacity:0;transform:translateY(-18px);} }



.controls fieldset{ border:1px solid #2a2b2f; border-radius:12px; padding:8px 10px; margin:6px 0; }
.controls legend{ font-size:12px; color:var(--muted); padding:0 6px; }
.controls .flag-buttons{ display:flex; gap:8px; }
.controls .flag-buttons label,.controls .chk{ display:inline-block; padding:6px 10px; border-radius:10px; background:#22232a; border:1px solid #2f3037; cursor:pointer; margin-right:8px; }

@media (max-width:960px){
  .hud-grid{ grid-template-columns:1fr; }
  .track-wrap{ width:100%; height:62.5vw; max-height:500px; }
}

/* =========================
   CAR CHOOSER UI
   ========================= */
.controls .car-chooser{ margin-top:6px; }
.controls .car-type{ display:flex; gap:8px; margin-bottom:8px; }
.controls .car-type label,.controls .car-opt{ display:inline-block; padding:6px 10px; border-radius:10px; background:#22232a; border:1px solid #2f3037; cursor:pointer; }
.controls .car-type input{ display:none; }
.controls .car-options{ display:none; gap:8px; }
.controls .car-opt{ width:44px; height:22px; padding:0; }

/* show options per type */
#type-f1:checked  ~ .hud-grid .car-chooser .car-options.f1{ display:flex; }
#type-road:checked ~ .hud-grid .car-chooser .car-options.road{ display:flex; }

/* selected type highlight */
#type-f1:checked  ~ .hud-grid .car-chooser .car-type label[for="type-f1"],
#type-road:checked ~ .hud-grid .car-chooser .car-type label[for="type-road"]{
  outline:2px solid var(--accent); box-shadow:0 0 10px rgba(0,230,184,.35);
}

/* tiny preview swatches */
.controls .car-options.f1  .car-opt:nth-child(1){ background:linear-gradient(90deg,#ff7a00 0 65%,#fff 0 80%,#ff7a00 0); }
.controls .car-options.f1  .car-opt:nth-child(2){ background:linear-gradient(90deg,#ff2d55 0 65%,#ffe36b 0 80%,#ff2d55 0); }
.controls .car-options.f1  .car-opt:nth-child(3){ background:linear-gradient(90deg,#48c7ff 0 65%,#a78bfa 0 80%,#48c7ff 0); }
.controls .car-options.road .car-opt:nth-child(1){ background:#ffb700; }
.controls .car-options.road .car-opt:nth-child(2){ background:#e8ebef; }
.controls .car-options.road .car-opt:nth-child(3){ background:#27d3b0; }

/* chosen skin thumb */
#skin-f1-1:checked ~ .hud-grid .car-chooser .car-options.f1  .car-opt:nth-child(1),
#skin-f1-2:checked ~ .hud-grid .car-chooser .car-options.f1  .car-opt:nth-child(2),
#skin-f1-3:checked ~ .hud-grid .car-chooser .car-options.f1  .car-opt:nth-child(3),
#skin-road-1:checked ~ .hud-grid .car-chooser .car-options.road .car-opt:nth-child(1),
#skin-road-2:checked ~ .hud-grid .car-chooser .car-options.road .car-opt:nth-child(2),
#skin-road-3:checked ~ .hud-grid .car-chooser .car-options.road .car-opt:nth-child(3){
  outline:2px solid var(--accent); box-shadow:0 0 10px rgba(0,230,184,.35);
}

/* =========================
   CAR SKINS — F1 (top-down) & ROAD
   ========================= */

/* ---- F1 skins (use with #type-f1 + #skin-f1-X) ---- */
#type-f1:checked ~ #skin-f1-1:checked ~ .hud-grid .car{
  background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 210 90' preserveAspectRatio='xMidYMid meet'>\
 <defs><style><![CDATA[ .o{stroke:%230b0b0c;stroke-width:12;stroke-linecap:round;stroke-linejoin:round} ]]></style></defs>\
 <g class='o'>\
  <circle cx='48' cy='18' r='11' fill='%23222222'/><circle cx='48' cy='18' r='6' fill='%23333333'/>\
  <circle cx='48' cy='62' r='11' fill='%23222222'/><circle cx='48' cy='62' r='6' fill='%23333333'/>\
  <circle cx='150' cy='18' r='11' fill='%23222222'/><circle cx='150' cy='18' r='6' fill='%23333333'/>\
  <circle cx='150' cy='62' r='11' fill='%23222222'/><circle cx='150' cy='62' r='6' fill='%23333333'/>\
 </g>\
 <rect x='16' y='10' width='12' height='60' rx='2' fill='%23ff7a00' class='o'/>\
 <rect x='26' y='20' width='120' height='40' rx='18' fill='%23ff7a00' class='o'/>\
 <rect x='70' y='30' width='42' height='20' rx='6' fill='%23ffffff' class='o'/>\
 <rect x='92' y='26' width='26' height='28' rx='10' fill='%2300d4ff' class='o'/>\
 <circle cx='105' cy='40' r='7' fill='%23ffffff' class='o'/>\
 <path d='M108 40 h8' stroke='%230b0b0c' stroke-width='8' stroke-linecap='round'/>\
 <path d='M146 20 L186 28 L186 52 L146 60 Z' fill='%23ff7a00' class='o'/>\
 <rect x='174' y='18' width='12' height='44' rx='2' fill='%23ffffff' class='o'/>\
</svg>");
}
#type-f1:checked ~ #skin-f1-2:checked ~ .hud-grid .car{
  background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 210 90' preserveAspectRatio='xMidYMid meet'>\
 <defs><style><![CDATA[ .o{stroke:%230b0b0c;stroke-width:12;stroke-linecap:round;stroke-linejoin:round} ]]></style></defs>\
 <g class='o'>\
  <circle cx='48' cy='18' r='11' fill='%23222222'/><circle cx='48' cy='18' r='6' fill='%23333333'/>\
  <circle cx='48' cy='62' r='11' fill='%23222222'/><circle cx='48' cy='62' r='6' fill='%23333333'/>\
  <circle cx='150' cy='18' r='11' fill='%23222222'/><circle cx='150' cy='18' r='6' fill='%23333333'/>\
  <circle cx='150' cy='62' r='11' fill='%23222222'/><circle cx='150' cy='62' r='6' fill='%23333333'/>\
 </g>\
 <rect x='16' y='10' width='12' height='60' rx='2' fill='%23ff2d55' class='o'/>\
 <rect x='26' y='20' width='120' height='40' rx='18' fill='%23ff2d55' class='o'/>\
 <rect x='70' y='30' width='42' height='20' rx='6' fill='%23ffe36b' class='o'/>\
 <rect x='92' y='26' width='26' height='28' rx='10' fill='%23cfe9ff' class='o'/>\
 <circle cx='105' cy='40' r='7' fill='%23ffffff' class='o'/>\
 <path d='M108 40 h8' stroke='%230b0b0c' stroke-width='8' stroke-linecap='round'/>\
 <path d='M146 20 L186 28 L186 52 L146 60 Z' fill='%23ff2d55' class='o'/>\
 <rect x='174' y='18' width='12' height='44' rx='2' fill='%23ffe36b' class='o'/>\
</svg>");
}
#type-f1:checked ~ #skin-f1-3:checked ~ .hud-grid .car{
  background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 210 90' preserveAspectRatio='xMidYMid meet'>\
 <defs><style><![CDATA[ .o{stroke:%230b0b0c;stroke-width:12;stroke-linecap:round;stroke-linejoin:round} ]]></style></defs>\
 <g class='o'>\
  <circle cx='48' cy='18' r='11' fill='%23222222'/><circle cx='48' cy='18' r='6' fill='%23333333'/>\
  <circle cx='48' cy='62' r='11' fill='%23222222'/><circle cx='48' cy='62' r='6' fill='%23333333'/>\
  <circle cx='150' cy='18' r='11' fill='%23222222'/><circle cx='150' cy='18' r='6' fill='%23333333'/>\
  <circle cx='150' cy='62' r='11' fill='%23222222'/><circle cx='150' cy='62' r='6' fill='%23333333'/>\
 </g>\
 <rect x='16' y='10' width='12' height='60' rx='2' fill='%2348c7ff' class='o'/>\
 <rect x='26' y='20' width='120' height='40' rx='18' fill='%2348c7ff' class='o'/>\
 <rect x='70' y='30' width='42' height='20' rx='6' fill='%23a78bfa' class='o'/>\
 <rect x='92' y='26' width='26' height='28' rx='10' fill='%23e2f5ff' class='o'/>\
 <circle cx='105' cy='40' r='7' fill='%23ffffff' class='o'/>\
 <path d='M108 40 h8' stroke='%230b0b0c' stroke-width='8' stroke-linecap='round'/>\
 <path d='M146 20 L186 28 L186 52 L146 60 Z' fill='%2348c7ff' class='o'/>\
 <rect x='174' y='18' width='12' height='44' rx='2' fill='%23a78bfa' class='o'/>\
</svg>");
}

/* ---- ROAD car skins (use with #type-road + #skin-road-X) ---- */
#type-road:checked ~ #skin-road-1:checked ~ .hud-grid .car{
  background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 80'>\
 <defs><style><![CDATA[ .o{stroke:%230b0b0c;stroke-width:10;stroke-linecap:round;stroke-linejoin:round} ]]></style></defs>\
 <rect x='20' y='10' width='14' height='20' rx='4' fill='%23222222' class='o'/>\
 <rect x='20' y='50' width='14' height='20' rx='4' fill='%23222222' class='o'/>\
 <rect x='126' y='10' width='14' height='20' rx='4' fill='%23222222' class='o'/>\
 <rect x='126' y='50' width='14' height='20' rx='4' fill='%23222222' class='o'/>\
 <rect x='30' y='12' width='100' height='56' rx='16' fill='%23ffb700' class='o'/>\
 <rect x='50' y='18' width='60' height='44' rx='8' fill='%232a2f33' class='o'/>\
 <rect x='30' y='58' width='8' height='6' rx='2' fill='%23ff5252'/>\
 <rect x='30' y='16' width='8' height='6' rx='2' fill='%23ff5252'/>\
</svg>");
}
#type-road:checked ~ #skin-road-2:checked ~ .hud-grid .car{
  background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 80'>\
 <defs><style><![CDATA[ .o{stroke:%230b0b0c;stroke-width:10;stroke-linecap:round;stroke-linejoin:round} ]]></style></defs>\
 <rect x='20' y='10' width='14' height='20' rx='4' fill='%23222222' class='o'/>\
 <rect x='20' y='50' width='14' height='20' rx='4' fill='%23222222' class='o'/>\
 <rect x='126' y='10' width='14' height='20' rx='4' fill='%23222222' class='o'/>\
 <rect x='126' y='50' width='14' height='20' rx='4' fill='%23222222' class='o'/>\
 <rect x='30' y='12' width='100' height='56' rx='16' fill='%23e8ebef' class='o'/>\
 <rect x='50' y='18' width='60' height='44' rx='8' fill='%232a2f33' class='o'/>\
 <rect x='30' y='58' width='8' height='6' rx='2' fill='%23ff5252'/>\
 <rect x='30' y='16' width='8' height='6' rx='2' fill='%23ff5252'/>\
</svg>");
}
#type-road:checked ~ #skin-road-3:checked ~ .hud-grid .car{
  background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 80'>\
 <defs><style><![CDATA[ .o{stroke:%230b0b0c;stroke-width:10;stroke-linecap:round;stroke-linejoin:round} ]]></style></defs>\
 <rect x='20' y='10' width='14' height='20' rx='4' fill='%23222222' class='o'/>\
 <rect x='20' y='50' width='14' height='20' rx='4' fill='%23222222' class='o'/>\
 <rect x='126' y='10' width='14' height='20' rx='4' fill='%23222222' class='o'/>\
 <rect x='126' y='50' width='14' height='20' rx='4' fill='%23222222' class='o'/>\
 <rect x='30' y='12' width='100' height='56' rx='16' fill='%2327d3b0' class='o'/>\
 <rect x='50' y='18' width='60' height='44' rx='8' fill='%232a2f33' class='o'/>\
 <rect x='30' y='58' width='8' height='6' rx='2' fill='%23ff5252'/>\
 <rect x='30' y='16' width='8' height='6' rx='2' fill='%23ff5252'/>\
</svg>");
}
/* === Flag → track background tint (keeps Yellow overlay untouched) === */
#flag-green:checked ~ .hud-grid .flag-bg{
  background-color:#0f251c;  /* deep green tint */
}

#flag-red:checked ~ .hud-grid .flag-bg{
  background-color:#281017;  /* deep red tint */
}
/* the normal lap is a straight 0%→100% sweep */
@keyframes normalLap{
  0%   { --prog-normal: 0%; }
  100% { --prog-normal: 100%; }
}

/* 24s */
@keyframes pitLap1{
  0%   { --prog-pit: var(--prog-normal); }                            /* start where we are */
  6%   { --prog-pit: calc(var(--prog-normal) + var(--pre-slow)); }    /* forward preslow */
  12%  { --prog-pit: calc(var(--pit-dist) - 2%); }                     /* ease to near box */
  15%  { --prog-pit: var(--pit-dist); }                                /* arrive box */
  40%  { --prog-pit: var(--pit-dist); }                                /* 6s hold */
  100% { --prog-pit: 100%; }
}

@keyframes pitLap2{
  0%   { --prog-pit: var(--prog-normal); }
  6%   { --prog-pit: calc(var(--prog-normal) + var(--pre-slow)); }
  12%  { --prog-pit: calc(var(--pit-dist) - 2%); }
  15%  { --prog-pit: var(--pit-dist); }
  45%  { --prog-pit: var(--pit-dist); }
  100% { --prog-pit: 100%; }
}

@keyframes pitLap3{
  0%   { --prog-pit: var(--prog-normal); }
  6%   { --prog-pit: calc(var(--prog-normal) + var(--pre-slow)); }
  12%  { --prog-pit: calc(var(--pit-dist) - 2%); }
  15%  { --prog-pit: var(--pit-dist); }
  52.5%{ --prog-pit: var(--pit-dist); }
  100% { --prog-pit: 100%; }
}

@keyframes pitLap4{
  0%   { --prog-pit: var(--prog-normal); }
  6%   { --prog-pit: calc(var(--prog-normal) + var(--pre-slow)); }
  12%  { --prog-pit: calc(var(--pit-dist) - 2%); }
  15%  { --prog-pit: var(--pit-dist); }
  65%  { --prog-pit: var(--pit-dist); }
  100% { --prog-pit: 100%; }
}

@keyframes pitLap5{
  0%   { --prog-pit: var(--prog-normal); }
  6%   { --prog-pit: calc(var(--prog-normal) + var(--pre-slow)); }
  12%  { --prog-pit: calc(var(--pit-dist) - 2%); }
  15%  { --prog-pit: var(--pit-dist); }
  81.667%{ --prog-pit: var(--pit-dist); }
  100% { --prog-pit: 100%; }
}

@keyframes pitLap6{
  0%   { --prog-pit: var(--prog-normal); }
  6%   { --prog-pit: calc(var(--prog-normal) + var(--pre-slow)); }
  12%  { --prog-pit: calc(var(--pit-dist) - 2%); }
  15%  { --prog-pit: var(--pit-dist); }
  95%  { --prog-pit: var(--pit-dist); }
  100% { --prog-pit: 100%; }
}

@keyframes pitLap7{
  0%   { --prog-pit: var(--prog-normal); }
  6%   { --prog-pit: calc(var(--prog-normal) + var(--pre-slow)); }
  12%  { --prog-pit: calc(var(--pit-dist) - 2%); }
  15%  { --prog-pit: var(--pit-dist); }
  95%  { --prog-pit: var(--pit-dist); }
  100% { --prog-pit: 100%; }
}


/* subtle “armed” pill that fades by the end of the lap */
#pit:checked ~ .hud-grid .toggles label[for="pit"]{
  position:relative;
  outline:2px solid var(--accent);
  box-shadow:0 0 0 4px rgba(0,230,184,.18);
}
#pit:checked ~ .hud-grid .toggles label[for="pit"]::after{
  content:"PIT • ONCE";
  position:absolute; left:50%; top:-10px; transform:translate(-50%,-100%);
  padding:2px 8px; border-radius:999px; font-size:11px; font-weight:700;
  background:var(--accent); color:#001b14; white-space:nowrap; opacity:1;
  animation: pitBadge calc(var(--base) * var(--flag-mult)) linear 1 forwards;
}
@keyframes pitBadge{
  0%, 80% { opacity:1; transform:translate(-50%,-100%) scale(1); }
  100%    { opacity:0; transform:translate(-50%,-120%) scale(.96); }
}
/* Preserve current car progress when PIT is clicked */
#pit:checked ~ .hud-grid .car {
  animation-delay: calc(-1 * var(--prog-normal) * var(--base) / 100); /* start pit animation at same progress */
}
/* ====== Splits card + toggle ====== */
.card.splits{
  position: relative;
  overflow: hidden;
}

/* header layout + toggle pill */
.card.splits .split-header{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; margin-bottom:8px;
}
.card.splits .split-header h3{ margin:0; }

.slide-toggle{
  display:inline-flex; align-items:center; gap:8px; user-select:none;
  font-size:14px; color:var(--ink);
}
.slide-toggle input{
  appearance:none; -webkit-appearance:none; width:46px; height:26px;
  border-radius:999px; border:1px solid #2f3037; background:#22232a;
  position:relative; cursor:pointer; outline:none;
  transition:background .25s ease, border-color .25s ease;
}
.slide-toggle input::after{
  content:""; position:absolute; top:3px; left:3px; width:20px; height:20px;
  border-radius:50%; background:#cfd3da; box-shadow:0 2px 8px rgba(0,0,0,.35);
  transition:transform .25s ease;
}
.slide-toggle input:checked{
  background:linear-gradient(90deg,#2bd4bd,#00e6b8); border-color:#00e6b8;
}
.slide-toggle input:checked::after{ transform:translateX(20px); }

/* ====== Slide-in panel ====== */
.card.splits .split-panel{
  border:1px solid #2a2b2f; border-radius:14px;
  background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 60%), #17181d;
  box-shadow:0 18px 48px rgba(0,0,0,.35);
  padding:12px; overflow:auto; max-height:40vh;

  /* slide from right */
  transform:translateX(110%);   /* hidden */
  transition:transform .35s cubic-bezier(.2,.85,.2,1), opacity .25s ease;
  opacity:.98;
}

/* Show when the section HAS the checked toggle (works with your HTML) */
.card.splits:has(#show-splits:checked) .split-panel{
  transform:translateX(0);
}

/* Table cosmetics (optional) */
.card.splits table{ width:100%; border-collapse:separate; border-spacing:0 6px; }
.card.splits thead th{
  text-align:left; font-weight:700; font-size:12px; color:var(--muted); padding:6px 8px;
}
.card.splits td, .card.splits th{ padding:8px 8px; }
.card.splits tbody tr{
  background:rgba(255,255,255,.02); border:1px solid rgba(255,255,255,.06);
  border-radius:10px; overflow:hidden;
}
.card.splits tbody tr td:first-child{ border-top-left-radius:10px; border-bottom-left-radius:10px; }
.card.splits tbody tr td:last-child{ border-top-right-radius:10px; border-bottom-right-radius:10px; }
.card.splits td.r{ text-align:right; }
.card.splits td.b{ font-weight:800; }

/* Mobile: slide down from top for better space */
@media (max-width: 720px){
  .card.splits .split-panel{ transform:translateY(-110%); }
  .card.splits:has(#show-splits:checked) .split-panel{ transform:translateY(0); }
}
